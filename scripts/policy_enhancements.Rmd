---
title: "Digital Divide Analysis: Policy Enhancement Module"
subtitle: "Spatial Regression Inference, County Case Studies, and Coverage Gap Analysis"
author: "Digital Divide Research Team"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: flatly
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

library(tidyverse)
library(sf)
library(spdep)
library(spatialreg)
library(knitr)
library(kableExtra)
library(scales)

# Load the analysis dataset
analysis_2020 <- readRDS("../processed_data/analysis_2020_county_final.rds")
analysis_2020_sf <- readRDS("../processed_data/analysis_2020_county_final_sf.rds")

# Load merged dataset for FCC/Ookla comparison
if (file.exists("../processed_data/merged_fcc_svi_airband_ookla_2020.rds")) {
  merged_all <- readRDS("../processed_data/merged_fcc_svi_airband_ookla_2020.rds")
}
```

---

# Enhancement 1: Spatial Regression for Policy Inference {.tabset}

## Why Spatial Models Matter for Policymakers

Standard regression (OLS) assumes that each county is independent of its neighbors. However, our Moran's I tests revealed **significant spatial autocorrelation** (I ≈ 0.53, p < 0.001), meaning nearby counties have correlated digital vulnerability levels. This clustering occurs because:

1. **Infrastructure spillovers**: ISPs build out from population centers, creating regional coverage patterns
2. **Economic regions**: Labor markets and economic conditions span multiple counties
3. **Policy boundaries**: State and regional broadband programs affect contiguous areas
4. **Geographic barriers**: Mountains, rivers, and rural isolation affect neighboring areas similarly

**Why this matters for policy:**

- OLS standard errors are **understated** when spatial autocorrelation exists
- Coefficient estimates may be **biased** if neighboring county effects are ignored
- Policy recommendations based on OLS may **misidentify** priority areas

**Recommendation**: Use **Spatial Error Model (SEM)** or **Spatial Lag Model (SAR)** results for policy inference, not OLS.

## Model Comparison Table

```{r spatial-model-comparison, message=FALSE, warning=FALSE}
# Prepare data for spatial models
basic_features <- c(
  "svi_overall", "income_median", "edu_bach",
  "internet_no_access", "airband_usage"
)

# Create clean spatial dataset
model_sf <- analysis_2020_sf %>%
  dplyr::select(digital_vulnerability_score, all_of(basic_features), geometry) %>%
  na.omit()

model_df <- model_sf %>% sf::st_drop_geometry()

# Build spatial weights
coords <- st_centroid(model_sf) %>% st_coordinates()
nb_queen <- poly2nb(model_sf, queen = TRUE)
lw_queen <- nb2listw(nb_queen, style = "W", zero.policy = TRUE)

# Formula
sp_formula <- as.formula(

  paste("digital_vulnerability_score ~", paste(basic_features, collapse = " + "))
)

# Fit models
ols_model <- lm(sp_formula, data = model_df)
sar_model <- lagsarlm(sp_formula, data = model_df, listw = lw_queen,
                       method = "eigen", zero.policy = TRUE)
sem_model <- errorsarlm(sp_formula, data = model_df, listw = lw_queen,
                         method = "eigen", zero.policy = TRUE)

# Extract coefficients
extract_coefs <- function(model, model_name) {
  if (inherits(model, "lm")) {
    coefs <- summary(model)$coefficients
    tibble(
      Model = model_name,
      Variable = rownames(coefs),
      Estimate = coefs[, "Estimate"],
      Std_Error = coefs[, "Std. Error"],
      P_Value = coefs[, "Pr(>|t|)"]
    )
  } else {
    coefs <- summary(model)$Coef
    tibble(
      Model = model_name,
      Variable = rownames(coefs),
      Estimate = coefs[, "Estimate"],
      Std_Error = coefs[, "Std. Error"],
      P_Value = coefs[, "Pr(>|z|)"]
    )
  }
}

coef_table <- bind_rows(
  extract_coefs(ols_model, "OLS"),
  extract_coefs(sar_model, "SAR (Spatial Lag)"),
  extract_coefs(sem_model, "SEM (Spatial Error)")
)

# Format comparison table
coef_wide <- coef_table %>%
  filter(Variable != "(Intercept)") %>%
  mutate(
    Significance = case_when(
      P_Value < 0.001 ~ "***",
      P_Value < 0.01 ~ "**",
      P_Value < 0.05 ~ "*",
      P_Value < 0.1 ~ ".",
      TRUE ~ ""
    ),
    Display = paste0(round(Estimate, 4), Significance)
  ) %>%
  dplyr::select(Model, Variable, Display) %>%
  pivot_wider(names_from = Model, values_from = Display)

kable(coef_wide,
      caption = "Coefficient Comparison: OLS vs Spatial Models",
      align = "lccc") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE) %>%
  footnote(general = "Significance: *** p<0.001, ** p<0.01, * p<0.05, . p<0.1")
```

## Model Fit Statistics

```{r model-fit-stats}
# Model fit comparison
fit_stats <- tibble(
  Metric = c("AIC", "Log-Likelihood", "Spatial Parameter", "R-squared / Pseudo-R²"),
  OLS = c(
    round(AIC(ols_model), 1),
    round(logLik(ols_model), 1),
    "N/A",
    round(summary(ols_model)$r.squared, 3)
  ),
  `SAR (Spatial Lag)` = c(
    round(AIC(sar_model), 1),
    round(sar_model$LL, 1),
    paste0("ρ = ", round(sar_model$rho, 3)),
    round(1 - (sar_model$SSE / sum((model_df$digital_vulnerability_score - mean(model_df$digital_vulnerability_score))^2)), 3)
  ),
  `SEM (Spatial Error)` = c(
    round(AIC(sem_model), 1),
    round(sem_model$LL, 1),
    paste0("λ = ", round(sem_model$lambda, 3)),
    round(1 - (sem_model$SSE / sum((model_df$digital_vulnerability_score - mean(model_df$digital_vulnerability_score))^2)), 3)
  )
)

kable(fit_stats,
      caption = "Model Fit Comparison",
      align = "lccc") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

## Policy Interpretation Guide

### Interpreting the Spatial Parameters

**SAR Model - Spatial Lag (ρ)**
```{r sar-interpretation}
rho_val <- round(sar_model$rho, 3)
cat(paste0("Estimated ρ = ", rho_val, "\n\n"))
```

- **Interpretation**: A 1-unit increase in the *average digital vulnerability of neighboring counties* is associated with a `r rho_val`-unit increase in a county's own digital vulnerability.
- **Policy implication**: Digital disadvantage is *contagious* - improving one county's broadband access has positive spillover effects on neighbors. Regional approaches are more effective than isolated interventions.

**SEM Model - Spatial Error (λ)**
```{r sem-interpretation}
lambda_val <- round(sem_model$lambda, 3)
cat(paste0("Estimated λ = ", lambda_val, "\n\n"))
```

- **Interpretation**: Unobserved factors affecting digital vulnerability are spatially correlated. Counties share unmeasured characteristics (regional economic conditions, state policies) that affect outcomes.
- **Policy implication**: County-level targeting based solely on observed characteristics will miss regional patterns. Consider state/regional context when allocating resources.

### Which Model Should Policymakers Use?

```{r model-recommendation}
# Compare AIC
aic_compare <- c(OLS = AIC(ols_model), SAR = AIC(sar_model), SEM = AIC(sem_model))
best_model <- names(which.min(aic_compare))

cat("Model Selection by AIC:\n")
print(round(aic_compare, 1))
cat(paste0("\nRecommended model for policy inference: ", best_model, "\n"))
```

**Key recommendations for policymakers:**

1. **Do NOT use OLS for causal claims** - The spatial autocorrelation violates independence assumptions
2. **Use spatial model coefficients** for estimating the impact of interventions
3. **Account for spillovers** - Budget for regional coordination, not just county-by-county funding
4. **Prioritize cluster areas** - High-High LISA clusters need coordinated multi-county approaches

---

# Enhancement 2: Top 20 High-Priority County Case Studies {.tabset}

## Priority County Profiles

```{r top20-counties, fig.height=10}
# Identify top 20 highest-priority counties
top_20_priority <- analysis_2020 %>%
  filter(!is.na(priority_score)) %>%
  arrange(desc(priority_score)) %>%
  dplyr::slice(1:20) %>%
  dplyr::select(
    GEOID, NAME.x, state_name,
    priority_score, priority_tier, cdvi_score, cdvi_tier,
    airband_usage, broadband_gap, tech_access_gap,
    svi_overall, income_median,
    avg_download_mbps, avg_latency_ms,
    rucc_2023, rural_urban_cat
  ) %>%
  mutate(
    Rank = row_number(),
    airband_usage_pct = round(airband_usage * 100, 1),
    broadband_gap_pct = round(broadband_gap * 100, 1),
    svi_percentile = round(svi_overall * 100, 0),
    income_k = round(income_median / 1000, 1)
  )

# Display table
top_20_display <- top_20_priority %>%
  dplyr::select(
    Rank, County = NAME.x, State = state_name,
    `Priority Score` = priority_score,
    `CDVI Tier` = cdvi_tier,
    `Broadband Usage (%)` = airband_usage_pct,
    `Coverage Gap (%)` = broadband_gap_pct,
    `SVI Percentile` = svi_percentile,
    `Median Income ($K)` = income_k,
    `Area Type` = rural_urban_cat
  ) %>%
  mutate(
    `Priority Score` = round(`Priority Score`, 2)
  )

kable(top_20_display,
      caption = "Top 20 Highest-Priority Counties for Broadband Intervention") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                font_size = 11) %>%
  row_spec(1:5, bold = TRUE, background = "#ffcccc") %>%
  row_spec(6:10, background = "#ffe6cc") %>%
  row_spec(11:15, background = "#ffffcc") %>%
  row_spec(16:20, background = "#e6ffcc")
```

## Regional Distribution

```{r regional-distribution}
# Analyze regional patterns in top 20
regional_summary <- top_20_priority %>%
  count(state_name, name = "Counties_in_Top20") %>%
  arrange(desc(Counties_in_Top20))

# Add region classification
state_regions <- tibble(
  state_name = c("Mississippi", "Texas", "Georgia", "Alaska", "Arizona",
                  "New Mexico", "Kentucky", "Alabama", "Louisiana", "South Dakota",
                  "North Dakota", "Montana", "West Virginia", "Arkansas", "Oklahoma"),
  Region = c("South", "South", "South", "West", "West",
             "West", "South", "South", "South", "Midwest",
             "Midwest", "West", "South", "South", "South")
)

regional_summary <- regional_summary %>%
  left_join(state_regions, by = "state_name")

cat("States with Multiple Counties in Top 20:\n")
print(regional_summary %>% filter(Counties_in_Top20 > 1))

# Summarize by region
cat("\n\nRegional Concentration:\n")
top_20_priority %>%
  left_join(state_regions, by = "state_name") %>%
  count(Region) %>%
  arrange(desc(n)) %>%
  print()
```

## Detailed County Profiles

```{r county-profiles}
# Create detailed profiles for top 5
top_5_profiles <- top_20_priority %>%
  dplyr::slice(1:5)

for (i in 1:5) {
  county <- top_5_profiles[i, ]
  cat(paste0("\n### ", i, ". ", county$NAME.x, ", ", county$state_name, "\n\n"))
  cat(paste0("**Priority Score:** ", round(county$priority_score, 2), " (", county$priority_tier, ")\n"))
  cat(paste0("**CDVI Score:** ", round(county$cdvi_score, 2), " (", county$cdvi_tier, ")\n\n"))

  cat("**Key Metrics:**\n")
  cat(paste0("- Broadband Usage: ", county$airband_usage_pct, "% of population\n"))
  cat(paste0("- Coverage-Usage Gap: ", county$broadband_gap_pct, " percentage points\n"))
  cat(paste0("- Social Vulnerability: ", county$svi_percentile, "th percentile\n"))
  cat(paste0("- Median Household Income: $", county$income_k, "K\n"))
  cat(paste0("- Area Classification: ", county$rural_urban_cat, " (RUCC ", county$rucc_2023, ")\n"))

  if (!is.na(county$avg_download_mbps)) {
    cat(paste0("- Actual Download Speed: ", round(county$avg_download_mbps, 1), " Mbps\n"))
    cat(paste0("- Network Latency: ", round(county$avg_latency_ms, 0), " ms\n"))
  }

  cat("\n**Recommended Interventions:**\n")
  if (county$airband_usage_pct < 20) {
    cat("- CRITICAL: Major infrastructure deployment needed\n")
  }
  if (county$svi_percentile > 80) {
    cat("- Affordability subsidies (ACP-style programs)\n")
  }
  if (county$rural_urban_cat == "Nonmetro-Nonadjacent") {
    cat("- Consider fixed wireless or satellite alternatives\n")
  }
  if (!is.na(county$avg_latency_ms) && county$avg_latency_ms > 100) {
    cat("- Network quality improvement (latency reduction)\n")
  }
  cat("\n---\n")
}
```

## Policy Recommendations by County Type

```{r county-type-recommendations}
# Classify top 20 into intervention types
intervention_types <- top_20_priority %>%
  mutate(
    Intervention_Type = case_when(
      airband_usage_pct < 15 & svi_percentile > 75 ~ "Infrastructure + Affordability",
      airband_usage_pct < 15 & svi_percentile <= 75 ~ "Infrastructure Priority",
      airband_usage_pct >= 15 & svi_percentile > 75 ~ "Affordability + Digital Literacy",
      broadband_gap_pct > 30 ~ "Adoption Promotion",
      TRUE ~ "Mixed Intervention"
    )
  ) %>%
  count(Intervention_Type) %>%
  arrange(desc(n))

kable(intervention_types,
      caption = "Recommended Intervention Types for Top 20 Counties",
      col.names = c("Intervention Strategy", "Number of Counties")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = FALSE)
```

---

# Enhancement 3: FCC Coverage vs Actual Performance Gap {.tabset}

## The Measurement Problem

The FCC's Form 477 data reports broadband **availability** - where an ISP *could* provide service if requested. However, this dramatically overstates actual connectivity:

```{r coverage-gap-summary}
if (exists("merged_all")) {
  gap_analysis <- merged_all %>%
    filter(!is.na(coverage_25_3), !is.na(avg_download_mbps)) %>%
    summarise(
      Counties = n(),
      FCC_Median_Coverage = median(coverage_25_3 * 100, na.rm = TRUE),
      FCC_Mean_Coverage = mean(coverage_25_3 * 100, na.rm = TRUE),
      Actual_Median_Speed = median(avg_download_mbps, na.rm = TRUE),
      Actual_Mean_Speed = mean(avg_download_mbps, na.rm = TRUE),
      Pct_Below_25Mbps = mean(avg_download_mbps < 25, na.rm = TRUE) * 100,
      Pct_Below_100Mbps = mean(avg_download_mbps < 100, na.rm = TRUE) * 100
    )

  cat("FCC vs Ookla Comparison Summary:\n\n")
  cat(paste0("Counties Analyzed: ", gap_analysis$Counties, "\n"))
  cat(paste0("FCC Reports: ", round(gap_analysis$FCC_Mean_Coverage, 1),
             "% of locations have 25/3 Mbps available\n"))
  cat(paste0("Reality (Ookla): ", round(gap_analysis$Pct_Below_25Mbps, 1),
             "% of counties have actual speeds BELOW 25 Mbps\n"))
  cat(paste0("Reality (Ookla): ", round(gap_analysis$Pct_Below_100Mbps, 1),
             "% of counties have actual speeds BELOW 100 Mbps\n"))
}
```

## Why the Gap Exists

| Factor | FCC Availability | Ookla Actual Performance |
|--------|------------------|--------------------------|
| **What it measures** | Where ISPs *could* serve | Where people *actually* connect |
| **Data source** | ISP self-reports | Real user speed tests |
| **Definition of coverage** | 1 location in census block = entire block "covered" | Actual measured speeds |
| **Affordability** | Not considered | Implicit (users must pay to test) |
| **Network congestion** | Not captured | Fully reflected |
| **Last-mile issues** | Not captured | Fully reflected |

## County-Level Gap Examples

```{r gap-examples}
if (exists("merged_all")) {
  # Find counties with largest gaps
  gap_counties <- merged_all %>%
    filter(!is.na(coverage_25_3), !is.na(avg_download_mbps)) %>%
    mutate(
      fcc_coverage_pct = coverage_25_3 * 100,
      meets_fcc_threshold = avg_download_mbps >= 25,
      gap_score = fcc_coverage_pct - (avg_download_mbps / 25 * 100)
    ) %>%
    arrange(desc(gap_score)) %>%
    dplyr::slice(1:15) %>%
    dplyr::select(
      NAME.x, state_name,
      fcc_coverage_pct, avg_download_mbps, avg_latency_ms,
      rural_urban_cat
    )

  gap_display <- gap_counties %>%
    mutate(
      `FCC 25/3 Coverage` = paste0(round(fcc_coverage_pct, 1), "%"),
      `Actual Speed` = paste0(round(avg_download_mbps, 1), " Mbps"),
      `Latency` = paste0(round(avg_latency_ms, 0), " ms"),
      Gap = case_when(
        avg_download_mbps < 10 ~ "CRITICAL",
        avg_download_mbps < 25 ~ "Severe",
        avg_download_mbps < 50 ~ "Moderate",
        TRUE ~ "Minor"
      )
    ) %>%
    dplyr::select(
      County = NAME.x, State = state_name,
      `FCC 25/3 Coverage`, `Actual Speed`, Latency,
      `Area Type` = rural_urban_cat, Gap
    )

  kable(gap_display,
        caption = "Counties with Largest FCC-to-Reality Gaps") %>%
    kable_styling(bootstrap_options = c("striped", "hover"), font_size = 11) %>%
    column_spec(7, bold = TRUE, color = ifelse(gap_display$Gap == "CRITICAL", "red",
                                                ifelse(gap_display$Gap == "Severe", "orange", "black")))
}
```

## Visualization: Coverage vs Reality

```{r coverage-vs-speed-plot, fig.width=12, fig.height=8}
if (exists("merged_all")) {
  viz_data <- merged_all %>%
    filter(!is.na(coverage_25_3), !is.na(avg_download_mbps), !is.na(rural_urban_cat))

  ggplot(viz_data, aes(x = coverage_25_3 * 100, y = avg_download_mbps)) +
    geom_point(aes(color = rural_urban_cat), alpha = 0.5, size = 2) +
    geom_hline(yintercept = 25, linetype = "dashed", color = "red", linewidth = 1) +
    geom_hline(yintercept = 100, linetype = "dashed", color = "blue", linewidth = 1) +
    geom_smooth(method = "lm", color = "black", linewidth = 1.2) +
    annotate("text", x = 60, y = 28, label = "FCC 25 Mbps threshold", color = "red", size = 3) +
    annotate("text", x = 60, y = 103, label = "Modern broadband (100 Mbps)", color = "blue", size = 3) +
    scale_color_manual(values = c(
      "Metro" = "#2E86AB",
      "Nonmetro-Adjacent" = "#F6AE2D",
      "Nonmetro-Nonadjacent" = "#E94F37"
    )) +
    labs(
      title = "The Coverage-Performance Gap: FCC Reports vs Reality",
      subtitle = "High FCC coverage does not guarantee adequate actual speeds",
      x = "FCC Reported 25/3 Mbps Coverage (%)",
      y = "Actual Average Download Speed (Mbps)",
      color = "Area Type",
      caption = "Data: FCC BDC (availability), Ookla Speedtest (actual performance)"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(size = 12, color = "gray40"),
      legend.position = "bottom"
    )
}
```

## Policy Implications

### For Federal Policymakers (NTIA, FCC)

1. **Revise coverage definitions**: The current census-block-level reporting inflates coverage statistics
2. **Incorporate performance data**: Use Ookla/M-Lab/SamKnows data to validate ISP claims
3. **Set higher thresholds**: 25/3 Mbps is obsolete; 100/20 Mbps should be the new baseline
4. **Fund actual performance testing**: Mandate third-party speed testing in funded areas

### For State Broadband Offices

1. **Don't trust FCC maps alone**: Cross-reference with actual speed test data
2. **Prioritize based on performance gaps**: Counties showing high FCC coverage but low actual speeds indicate ISP underperformance
3. **Include latency requirements**: Speed alone is insufficient; require <50ms latency for interactive applications
4. **Challenge inaccurate provider claims**: Use the FCC's challenge process with actual performance data

### For BEAD Program Implementation

1. **Use performance-adjusted maps**: Weight FCC coverage by actual Ookla speeds in that area
2. **Require post-deployment testing**: Funded projects must demonstrate actual (not just theoretical) performance
3. **Set enforceable minimums**: Include clawback provisions for providers who don't meet speed guarantees

---

# Summary: Key Takeaways for Policymakers

```{r summary-box}
cat("
================================================================================
                    DIGITAL DIVIDE POLICY ENHANCEMENT SUMMARY
================================================================================

1. SPATIAL REGRESSION FINDINGS
   - OLS regression UNDERESTIMATES uncertainty due to spatial autocorrelation
   - Use SAR or SEM model results for policy decisions
   - Digital disadvantage clusters regionally - target AREAS, not just counties
   - Spillover effects mean multi-county approaches are more efficient

2. TOP 20 PRIORITY COUNTIES
   - Concentrated in South and rural West regions
   - Common profile: <20% broadband usage, >75th percentile SVI
   - Most need BOTH infrastructure AND affordability interventions
   - Remote rural areas may need alternative technologies (fixed wireless, LEO satellite)

3. FCC COVERAGE GAP
   - FCC reports ~98% coverage for 25/3 Mbps
   - Reality: ~15% of counties have actual speeds BELOW 25 Mbps
   - Rural counties most affected by the measurement gap
   - Policy should be based on ACTUAL PERFORMANCE, not reported availability

================================================================================
")
```

```{r save-outputs}
# Save top 20 priority counties for external use
if (exists("top_20_priority")) {
  write_csv(top_20_priority, "../outputs/top_20_priority_counties.csv")
  cat("\nTop 20 priority counties saved to: outputs/top_20_priority_counties.csv\n")
}
```
